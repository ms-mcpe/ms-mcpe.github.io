<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffd700">
    <title>DevZynx Studio | </title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #ffd700;
            --primary-glow: rgba(255, 215, 0, 0.4);
            --bg-dark: #050505;
            --bg-panel: rgba(20, 20, 20, 0.6);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-sec: #a0a0a0;
            --danger: #ff3b3b;
            --success: #00e676;
            --font-main: 'Outfit', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 215, 0, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(50, 50, 255, 0.05) 0%, transparent 20%);
            color: var(--text-main);
            font-family: var(--font-main);
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- LOADER --- */
        #app-loader {
            position: fixed; inset: 0; background: #000; z-index: 99999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s ease;
        }
        .loader-spinner {
            width: 50px; height: 50px; border: 3px solid transparent;
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- UI COMPONENTS --- */
        button { cursor: pointer; font-family: var(--font-tech); text-transform: uppercase; letter-spacing: 1px; }
        img { pointer-events: none; -webkit-user-drag: none; }

        /* --- HEADER --- */
        .app-header {
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; z-index: 100;
        }
        .header-title { font-family: var(--font-tech); color: var(--primary); font-size: 1.1rem; text-shadow: 0 0 10px var(--primary-glow); }
        .menu-btn { background: none; border: none; color: white; font-size: 1.4rem; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: 0; left: 0; width: 280px; height: 100%;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            transform: translateX(-100%); transition: transform 0.4s var(--ease);
            z-index: 1000; border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
        }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid var(--glass-border); }
        .sidebar-logo { font-family: var(--font-tech); color: var(--primary); font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .nav-list { list-style: none; padding: 20px; margin: 0; }
        .nav-item { margin-bottom: 10px; }
        .nav-link {
            display: flex; align-items: center; gap: 15px; padding: 12px 15px;
            color: var(--text-sec); text-decoration: none; border-radius: 8px;
            transition: 0.3s; font-weight: 500;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255, 215, 0, 0.1); color: var(--primary); }
        .nav-link i { width: 20px; text-align: center; }

        /* --- MAIN CONTENT --- */
        .main-container { flex: 1; overflow-y: auto; padding: 5px; position: relative; }
        .page-section { display: none; animation: slideUp 0.5s var(--ease); max-width: 1200px; margin: 0 auto; }
        .page-section.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- SEARCH & CONTROLS --- */
        .controls-wrapper {
            position: sticky; top: 0; background: var(--bg-dark); z-index: 50;
            padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); margin-bottom: 20px;
        }
        
        .search-container {
            position: relative; margin-bottom: 15px;
        }
        .search-container i {
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sec);
        }
        .search-input {
            width: 100%; padding: 12px 12px 12px 45px;
            background: var(--bg-panel); border: 1px solid var(--glass-border);
            border-radius: 50px; color: white; font-family: var(--font-main);
            transition: 0.3s;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(255,215,0,0.1); }

        .filter-bar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .chip {
            padding: 8px 16px; background: var(--glass); border: 1px solid var(--glass-border);
            color: var(--text-sec); border-radius: 20px; font-size: 0.8rem; white-space: nowrap;
            transition: 0.3s;
        }
        .chip:hover, .chip.active { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-glow); border-color: var(--primary); }

        /* --- GRID CARDS --- */
        .grid-layout {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px;
        }
        .card {
            background: var(--bg-panel); border: 1px solid var(--glass-border); border-radius: 16px;
            overflow: hidden; position: relative; transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-color: rgba(255,215,0,0.3); }
        
        .card-img-container { width: 100%; height: 160px; overflow: hidden; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .card:hover .card-img { transform: scale(1.1); }
        
        .card-body { padding: 15px; }
        .card-title { margin: 0 0 5px 0; font-size: 1rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-sec); margin-top: 10px; }
        .badge-cat { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px; color: var(--primary); }
        .badge-ver { color: #aaa; margin-left: 5px; font-size: 0.7rem; }
        
        .card-actions-float {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 10;
        }
        .mini-btn {
            width: 32px; height: 32px; border-radius: 50%; border: none; color: white;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            backdrop-filter: blur(5px); transition: 0.2s;
        }
        .btn-del { background: rgba(255, 59, 59, 0.8); }
        .btn-edit { background: rgba(0, 140, 255, 0.8); }
        .mini-btn:hover { transform: scale(1.1); }

        /* --- FORMS --- */
        .glass-panel {
            background: var(--bg-panel); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-label { display: block; margin-bottom: 8px; color: var(--primary); font-size: 0.85rem; font-weight: 600; }
        .input-box {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
            border-radius: 10px; color: white; font-family: var(--font-main); transition: 0.3s;
        }

        textarea.input-box { resize: vertical; min-height: 100px; }
        .input-box:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); }
        
        select.input-box { appearance: none; cursor: pointer; }

        /* MENSAJE DE DUPLICADO */
        .danger-text {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
            font-weight: 600;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .btn-primary {
            width: 100%; padding: 15px; background: var(--primary); color: #000;
            border: none; border-radius: 10px; font-weight: 800; font-size: 1rem;
            transition: 0.3s; margin-top: 10px; position: relative; overflow: hidden;
        }
        .btn-primary:hover:not(:disabled) {
            background: #fff; box-shadow: 0 0 20px var(--primary); transform: translateY(-2px);
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .btn-secondary {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-sec);
        }
        .btn-secondary:hover { border-color: white; color: white; }

        /* --- FAB --- */
        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: var(--primary); color: #000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.3); border: none; z-index: 900;
            transition: 0.4s var(--ease);
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 15px 30px rgba(255, 215, 0, 0.5); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 10000; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-box {
            background: #111; border: 1px solid var(--primary); width: 90%; max-width: 450px;
            padding: 30px; border-radius: 20px; text-align: center; position: relative;
            transform: scale(0.9); transition: 0.3s var(--ease); box-shadow: 0 0 40px rgba(255,215,0,0.1);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .overlay-click { position: absolute; inset: 0; z-index: -1; }
        .text-link { color: var(--primary); cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="app-loader">
        <div class="loader-spinner"></div>
        <p style="margin-top:20px; font-family:var(--font-tech); color:var(--text-sec); letter-spacing:2px;">CARGANDO SISTEMA...</p>
    </div>

    <div class="overlay-click" id="sidebar-overlay" onclick="toggleSidebar()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999;"></div>

    <div id="authModal" class="modal-overlay">
        <div class="modal-box">
            <i class="fas fa-shield-alt" style="font-size:3rem; color:var(--primary); margin-bottom:20px;"></i>
            <h2 id="authTitle" style="color:white; font-family:var(--font-tech); margin:0 0 20px 0;">ACCESO SEGURO</h2>
            <div class="form-group"><input type="text" id="auth-user" class="input-box" placeholder="Usuario"></div>
            <div class="form-group"><input type="password" id="auth-pass" class="input-box" placeholder="Contraseña"></div>
            <button class="btn-primary" onclick="handleAuth()" id="btnAuth">INGRESAR</button>
            <p id="authSwitchText" style="font-size:0.9rem; margin-top:20px; color:var(--text-sec);">
                ¿Nuevo aquí? <span class="text-link" onclick="switchAuth(true)">Crear cuenta</span>
            </p>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-box" style="text-align:left;">
            <h2 style="color:var(--primary); font-family:var(--font-tech); margin-top:0;">EDITAR CONTENIDO</h2>
            <input type="hidden" id="edit-original-name">
            
            <div class="form-group">
                <label class="form-label">Nombre del Contenido</label>
                <input type="text" id="edit-nombre" class="input-box">
                <small id="edit-dupe-msg" class="danger-text"></small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Categoría</label>
                <select id="edit-cat" class="input-box">
                    <option value="plugins">Plugins</option>
                    <option value="Maps">Mapas</option>
                    <option value="server">Servers</option>
                    <option value="host">Host</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Versión / Modelo</label>
                <input type="text" id="edit-version" class="input-box" value="1.0" placeholder="Ej: 1.0 o 2.0">
            </div>

            <div class="form-group">
                <label class="form-label">Link Descarga (cuty)</label>
                <input type="text" id="edit-url" class="input-box">
            </div>

            <div class="form-group">
                <label class="form-label">Descripción</label>
                <textarea id="edit-desc" class="input-box" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Actualizar Imagen (Opcional)</label>
                <input type="file" id="edit-img" accept="image/*" class="input-box" style="padding:10px;">
            </div>
            
            <button class="btn-primary" onclick="procesarEdicion()" id="btnSaveEdit">GUARDAR CAMBIOS</button>
            <button class="btn-primary btn-secondary" onclick="closeEditModal()" style="margin-top:10px;">CANCELAR</button>
        </div>
    </div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><i class="fas fa-cube"></i> MC STUDIO</div>
            <p style="font-size:0.8rem; color:var(--text-sec); margin:5px 0 0 0;">Panel de Creador v1.5</p>
        </div>
        <ul class="nav-list">
            <li class="nav-item"><a href="#" onclick="showPage('home'); toggleSidebar()" class="nav-link active"><i class="fas fa-home"></i> Inicio</a></li>
            <li class="nav-item"><a href="#" onclick="showPage('upload'); toggleSidebar()" class="nav-link"><i class="fas fa-cloud-upload-alt"></i> Subir</a></li>
            <li class="nav-item" id="logout-item" style="display:none; border-top:1px solid var(--glass-border); margin-top:20px; padding-top:20px;">
                <a href="#" onclick="logout()" class="nav-link" style="color:var(--danger);"><i class="fas fa-sign-out-alt"></i> Salir</a>
            </li>
        </ul>
    </nav>

    <header class="app-header">
        <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="header-title">DASHBOARD</div>
        <div style="width:30px;"></div>
    </header>

    <div class="main-container">
        <main id="home" class="page-section active">
            <div class="controls-wrapper">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar apps, juegos, mapas..." onkeyup="filtrarGrid()">
                </div>

                <div class="filter-bar">
                    <button class="chip active" id="btn-mode-all" onclick="setGestionMode(null)">Explorar Todo</button>
                    <button class="chip" id="btn-mode-edit" onclick="setGestionMode('edit')"><i class="fas fa-pen"></i> Mis Publicaciones</button>
                    <button class="chip" id="btn-mode-del" onclick="setGestionMode('delete')"><i class="fas fa-trash"></i> Borrar</button>
                </div>
            </div>
            <div id="addon-grid" class="grid-layout"></div>
        </main>

        <section id="upload" class="page-section">
            <div class="glass-panel" style="max-width:600px; margin:0 auto;">
                <h2 style="text-align:center; color:var(--primary); font-family:var(--font-tech); margin-bottom:30px;">
                    <i class="fas fa-rocket"></i> PUBLICAR CONTENIDO
                </h2>
                <form id="uploadForm">
                    <div class="form-group">
                        <label class="form-label">Título</label>
                        <input type="text" id="up-nombre" class="input-box" required placeholder="Nombre del archivo">
                        <small id="up-dupe-msg" class="danger-text"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Categoría</label>
                        <select id="up-categoria" class="input-box" required>
                            <option value="plugins">Plugins</option>
                            <option value="Maps">Mapas</option>
                            <option value="server">Servers</option>
                            <option value="host">Host</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Versión / Modelo</label>
                        <input type="text" id="up-version" class="input-box" required placeholder="Ej: v1.0.2">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Enlace Directo (cuty)</label>
                        <input type="url" id="up-url" class="input-box" required placeholder="https://cuty.io/...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descripción</label>
                        <textarea id="up-desc" class="input-box" required rows="4" placeholder="Detalles del contenido..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Imagen de Portada</label>
                        <input type="file" id="up-img" accept="image/*" required class="input-box" style="padding:10px;">
                    </div>

                    <input type="hidden" id="up-autor">
                    <button type="submit" class="btn-primary" id="btnSend">PUBLICAR AHORA</button>
                    <button type="button" class="btn-primary btn-secondary" onclick="showPage('home')">CANCELAR</button>
                </form>
            </div>
        </section>
    </div>

    <button class="fab" onclick="showPage('upload')"><i class="fas fa-plus"></i></button>

<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbx4hwo0p_fSm-UP5kHrvMYT7vJDYJFeEQk_T6S5uSMtrAxngffkD9ROcPa0wZ3BXQ1CEg/exec"; 
    let currentUser = localStorage.getItem('mc_user') || null;
    let modoGestion = null;
    let isRegisterMode = false;
    let datosLocales = [];

    // Protecciones
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    window.addEventListener('load', () => {
        setTimeout(() => {
            document.getElementById('app-loader').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('app-loader').style.display = 'none';
                checkSession();
            }, 500);
        }, 800);
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        sidebar.classList.toggle('active');
        overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
    }

    function showPage(pageId) {
        document.querySelectorAll('.page-section').forEach(sec => {
            sec.classList.remove('active');
            sec.style.display = 'none';
        });
        const target = document.getElementById(pageId);
        target.style.display = 'block';
        setTimeout(() => target.classList.add('active'), 10);
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    }

    function checkSession() {
        if (!currentUser) {
            document.getElementById('authModal').classList.add('show');
        } else {
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('up-autor').value = currentUser;
            document.getElementById('logout-item').style.display = 'block';
            cargarAddons();
        }
    }

    function switchAuth(mode) {
        isRegisterMode = mode;
        document.getElementById('authTitle').innerText = mode ? "CREAR CUENTA" : "ACCESO SEGURO";
        document.getElementById('btnAuth').innerText = mode ? "REGISTRARME" : "INGRESAR";
        document.getElementById('authSwitchText').innerHTML = mode ? 
            `¿Ya tienes cuenta? <span class="text-link" onclick="switchAuth(false)">Ingresar</span>` :
            `¿Nuevo aquí? <span class="text-link" onclick="switchAuth(true)">Crear cuenta</span>`;
    }

    async function handleAuth() {
        const user = document.getElementById('auth-user').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        const btn = document.getElementById('btnAuth');
        if(!user || !pass) return alert("Completa los campos.");
        btn.disabled = true; btn.innerHTML = '...';
        try {
            const response = await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: isRegisterMode ? "register" : "login", user, pass }) });
            const text = await response.text();
            if (text.includes("OK")) {
                localStorage.setItem('mc_user', user);
                location.reload();
            } else alert("Error: " + text);
        } catch (e) { alert("Error de conexión."); }
        finally { btn.disabled = false; btn.innerText = isRegisterMode ? "REGISTRARME" : "INGRESAR"; }
    }

    function logout() { localStorage.removeItem('mc_user'); location.reload(); }

    async function cargarAddons() {
        const grid = document.getElementById('addon-grid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;">Cargando...</div>';
        try {
            const response = await fetch(scriptURL + "?action=read");
            datosLocales = await response.json();
            grid.innerHTML = "";
            datosLocales.slice().reverse().forEach((addon) => {
                const [fecha, nombre, link, img, cat, likes, dls, seed, autor, version, descripcion] = addon;
                
                // Si estamos en modo gestión y no somos el autor, ignoramos esta tarjeta
                if (modoGestion && autor !== currentUser) return;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.setAttribute('data-version', version || '');
                
                let actions = "";
                if (modoGestion === 'delete' && autor === currentUser) {
                    actions = `<div class="card-actions-float"><button class="mini-btn btn-del" onclick="eliminarAddon('${nombre.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button></div>`;
                }
                
                if (modoGestion === 'edit' && autor === currentUser) {
                    // Preparamos los textos para que sean seguros dentro de la función onclick del HTML
                    const safeNombre = nombre ? nombre.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
                    const safeLink = link ? link.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
                    const safeVer = version ? version.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
                    const safeDesc = descripcion ? descripcion.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n') : '';
                    const safeCat = cat ? cat.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';

                    actions = `<div class="card-actions-float">
                        <button class="mini-btn btn-edit" onclick="openEditModal('${safeNombre}', '${safeLink}', '${safeVer}', '${safeDesc}', '${safeCat}')">
                            <i class="fas fa-pen"></i>
                        </button>
                    </div>`;
                }

                card.innerHTML = `
                    ${actions}
                    <div class="card-img-container"><img src="${img}" class="card-img" loading="lazy"></div>
                    <div class="card-body">
                        <h3 class="card-title">${nombre}</h3>
                        <div class="card-meta">
                            <span class="badge-cat">${cat}</span>
                            <span class="badge-ver">${version || ''}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (e) { 
            console.error(e);
            grid.innerHTML = "Error al cargar."; 
        }
    }

    document.getElementById('uploadForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSend');
        btn.disabled = true; btn.innerText = 'SUBIENDO...';
        
        const payload = {
            action: "add",
            nombre: document.getElementById('up-nombre').value,
            category: document.getElementById('up-categoria').value,
            link: document.getElementById('up-url').value,
            subidoPor: currentUser,
            img: await toBase64(document.getElementById('up-img').files[0]),
            version: document.getElementById('up-version').value,
            descripcion: document.getElementById('up-desc').value.replace(/\n/g, '\\n')
        };
        
        try {
            await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
            alert("¡Publicado!");
            location.reload();
        } catch (e) { alert("Error al subir."); btn.disabled = false; }
    };

    function openEditModal(nombre, link, version, desc, cat) {
        document.getElementById('edit-original-name').value = nombre;
        document.getElementById('edit-nombre').value = nombre;
        document.getElementById('edit-url').value = link;
        document.getElementById('edit-version').value = version;
        document.getElementById('edit-cat').value = cat;
        
        // Convertimos el texto literal \n de vuelta a saltos de línea reales para el textarea
        const decorado = desc.split('\\n').join('\n');
        document.getElementById('edit-desc').value = decorado;
        
        document.getElementById('editModal').classList.add('show');
    }

    async function procesarEdicion() {
        const btn = document.getElementById('btnSaveEdit');
        btn.disabled = true;
        
        const payload = {
            action: "edit",
            nombreOriginal: document.getElementById('edit-original-name').value,
            nuevoNombre: document.getElementById('edit-nombre').value,
            nuevaUrl: document.getElementById('edit-url').value,
            usuario: currentUser,
            nuevaVersion: document.getElementById('edit-version').value,
            nuevaDescripcion: document.getElementById('edit-desc').value.replace(/\n/g, '\\n'),
            nuevaCat: document.getElementById('edit-cat').value
        };
        
        const file = document.getElementById('edit-img').files[0];
        if(file) payload.nuevaImg = await toBase64(file);
        
        try {
            const response = await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await response.text();
            if(result.includes("OK")) {
                location.reload();
            } else {
                alert("Error del servidor: " + result);
                btn.disabled = false;
            }
        } catch (e) { 
            alert("Error de conexión"); 
            btn.disabled = false; 
        }
    }

    async function eliminarAddon(nombre) {
        if(!confirm("¿Eliminar este contenido?")) return;
        try {
            await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "delete", nombre, usuario: currentUser }) });
            cargarAddons();
        } catch (e) { alert("Error al eliminar"); }
    }

    function filtrarGrid() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.card').forEach(c => {
            const text = c.innerText.toLowerCase();
            c.style.display = text.includes(q) ? 'block' : 'none';
        });
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = e => reject(e);
    });

    function setGestionMode(mode) {
        modoGestion = mode;
        document.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
        if(!mode) document.getElementById('btn-mode-all').classList.add('active');
        else if(mode === 'edit') document.getElementById('btn-mode-edit').classList.add('active');
        else document.getElementById('btn-mode-del').classList.add('active');
        cargarAddons();
    }

    function closeEditModal() { document.getElementById('editModal').classList.remove('show'); }

    // Detección de duplicados
    document.getElementById('up-nombre').addEventListener('input', function() {
        const val = this.value.trim().toLowerCase();
        const found = datosLocales.find(a => a[1] && a[1].toLowerCase() === val);
        const btn = document.getElementById('btnSend');
        const msg = document.getElementById('up-dupe-msg');
        if(found) {
            msg.innerText = "⚠️ Ya publicado por " + found[8];
            msg.style.display = "block";
            btn.disabled = true;
        } else {
            msg.style.display = "none";
            btn.disabled = false;
        }
    });
</script>
</body>
</html>
